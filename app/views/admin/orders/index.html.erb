<% content_for :title, "Управление заказами" %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8);">
  <h1 style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
    Заказы
  </h1>
</div>

<!-- Statistics Cards -->
<div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: var(--space-4); margin-bottom: var(--space-8);">
  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-2);">Всего заказов</div>
    <div style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);"><%= @stats[:total_orders] %></div>
  </div>

  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-2);">Ожидают оплаты</div>
    <div style="font-size: 1.875rem; font-weight: 700; color: var(--yellow-600);"><%= @stats[:pending_orders] %></div>
  </div>

  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-2);">Оплачено</div>
    <div style="font-size: 1.875rem; font-weight: 700; color: var(--green-600);"><%= @stats[:paid_orders] %></div>
  </div>

  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-2);">Выручка</div>
    <div style="font-size: 1.875rem; font-weight: 700; color: var(--primary);"><%= format_currency(@stats[:total_revenue]) %></div>
  </div>
</div>

<!-- Filters -->
<div class="card" style="padding: var(--space-6); margin-bottom: var(--space-6);">
  <%= form_with url: admin_orders_path, method: :get, style: "display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: var(--space-4); align-items: end;" do |f| %>
    <div>
      <label style="display: block; margin-bottom: var(--space-2); font-size: 0.875rem; color: var(--gray-700);">Поиск (номер/email)</label>
      <%= f.text_field :search, value: params[:search], placeholder: "BR-2026-0001 или email...", style: "width: 100%; padding: var(--space-3); border: 1px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.875rem;" %>
    </div>

    <div>
      <label style="display: block; margin-bottom: var(--space-2); font-size: 0.875rem; color: var(--gray-700);">Статус</label>
      <%= f.select :status,
        [['Все', ''], ['Ожидание', 'pending'], ['Оплачен', 'paid'], ['Завершен', 'completed'], ['Отменен', 'cancelled'], ['Возврат', 'refunded']],
        {},
        style: "width: 100%; padding: var(--space-3); border: 1px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.875rem;" %>
    </div>

    <div>
      <label style="display: block; margin-bottom: var(--space-2); font-size: 0.875rem; color: var(--gray-700);">Дата от</label>
      <%= f.date_field :date_from, value: params[:date_from], style: "width: 100%; padding: var(--space-3); border: 1px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.875rem;" %>
    </div>

    <div>
      <label style="display: block; margin-bottom: var(--space-2); font-size: 0.875rem; color: var(--gray-700);">Дата до</label>
      <%= f.date_field :date_to, value: params[:date_to], style: "width: 100%; padding: var(--space-3); border: 1px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.875rem;" %>
    </div>

    <%= f.submit "Фильтровать", style: "padding: var(--space-3) var(--space-5); background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-weight: 500; cursor: pointer;" %>
  <% end %>
</div>

<!-- Orders Table -->
<div class="card">
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr style="border-bottom: 1px solid var(--gray-200);">
        <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Номер заказа</th>
        <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Пользователь</th>
        <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Сумма</th>
        <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Товары</th>
        <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Статус</th>
        <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Дата</th>
        <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Действия</th>
      </tr>
    </thead>
    <tbody>
      <% @orders.each do |order| %>
        <tr style="border-bottom: 1px solid var(--gray-100);">
          <td style="padding: var(--space-4);">
            <div style="font-weight: 600; color: var(--gray-900); font-family: monospace;"><%= order.order_number %></div>
            <% if order.payment_id.present? %>
              <div style="font-size: 0.75rem; color: var(--gray-500);">ID: <%= order.payment_id %></div>
            <% end %>
          </td>
          <td style="padding: var(--space-4);">
            <div style="font-weight: 500; color: var(--gray-900);"><%= order.user.full_name %></div>
            <div style="font-size: 0.875rem; color: var(--gray-600);"><%= order.user.email %></div>
          </td>
          <td style="padding: var(--space-4); text-align: right;">
            <div style="font-weight: 600; color: var(--gray-900); font-size: 1rem;"><%= format_currency(order.total_kopecks) %></div>
          </td>
          <td style="padding: var(--space-4); color: var(--gray-700);">
            <%= pluralize(order.order_items.count, 'товар', 'товара', 'товаров') %>
          </td>
          <td style="padding: var(--space-4);">
            <% case order.status %>
            <% when 'pending' %>
              <span style="padding: 4px 12px; background: rgba(245, 158, 11, 0.1); color: #D97706; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">Ожидание</span>
            <% when 'paid' %>
              <span style="padding: 4px 12px; background: rgba(34, 197, 94, 0.1); color: #16A34A; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">Оплачен</span>
            <% when 'completed' %>
              <span style="padding: 4px 12px; background: rgba(59, 130, 246, 0.1); color: #2563EB; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">Завершен</span>
            <% when 'cancelled' %>
              <span style="padding: 4px 12px; background: rgba(239, 68, 68, 0.1); color: #DC2626; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">Отменен</span>
            <% when 'refunded' %>
              <span style="padding: 4px 12px; background: rgba(168, 85, 247, 0.1); color: #9333EA; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">Возврат</span>
            <% end %>
          </td>
          <td style="padding: var(--space-4);">
            <div style="font-size: 0.875rem; color: var(--gray-700);"><%= order.created_at.strftime('%d.%m.%Y') %></div>
            <div style="font-size: 0.75rem; color: var(--gray-500);"><%= order.created_at.strftime('%H:%M') %></div>
          </td>
          <td style="padding: var(--space-4); text-align: right;">
            <%= link_to "Детали", admin_order_path(order), style: "padding: var(--space-2) var(--space-3); color: var(--primary); text-decoration: none; font-size: 0.875rem; font-weight: 500;" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @orders.empty? %>
    <div style="padding: var(--space-12); text-align: center; color: var(--gray-500);">
      Заказы не найдены
    </div>
  <% end %>
</div>

<%= paginate @orders %>
