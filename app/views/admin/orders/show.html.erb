<% content_for :title, "–ó–∞–∫–∞–∑ #{@order.order_number}" %>

<div style="margin-bottom: var(--space-6);">
  <%= link_to "‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º", admin_orders_path, style: "color: var(--primary); text-decoration: none; font-weight: 500;" %>
</div>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-8);">
  <div>
    <h1 style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-2);">
      –ó–∞–∫–∞–∑ #<%= @order.order_number %>
    </h1>
    <div style="display: flex; align-items: center; gap: var(--space-3);">
      <% case @order.status %>
      <% when 'pending' %>
        <span style="padding: 6px 16px; background: rgba(245, 158, 11, 0.1); color: #D97706; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</span>
      <% when 'paid' %>
        <span style="padding: 6px 16px; background: rgba(34, 197, 94, 0.1); color: #16A34A; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">–û–ø–ª–∞—á–µ–Ω</span>
      <% when 'completed' %>
        <span style="padding: 6px 16px; background: rgba(59, 130, 246, 0.1); color: #2563EB; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
      <% when 'cancelled' %>
        <span style="padding: 6px 16px; background: rgba(239, 68, 68, 0.1); color: #DC2626; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">–û—Ç–º–µ–Ω–µ–Ω</span>
      <% when 'refunded' %>
        <span style="padding: 6px 16px; background: rgba(168, 85, 247, 0.1); color: #9333EA; border-radius: 9999px; font-size: 0.875rem; font-weight: 500;">–í–æ–∑–≤—Ä–∞—Ç</span>
      <% end %>
      <span style="color: var(--gray-600); font-size: 0.875rem;"><%= @order.created_at.strftime('%d.%m.%Y %H:%M') %></span>
    </div>
  </div>

  <!-- Order Actions -->
  <div style="display: flex; gap: var(--space-3);">
    <% if @order.status_paid? %>
      <%= button_to "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑", admin_order_path(@order), method: :patch, params: { order_action: 'complete' }, class: "btn", style: "background: var(--primary); color: white;", data: { confirm: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑?" } %>
      <%= button_to "–í–æ–∑–≤—Ä–∞—Ç", admin_order_path(@order), method: :patch, params: { order_action: 'refund' }, class: "btn btn-outline", style: "color: var(--color-error); border-color: var(--color-error);", data: { confirm: "–í–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." } %>
    <% elsif @order.status_pending? %>
      <%= button_to "–û—Ç–º–µ–Ω–∏—Ç—å", admin_order_path(@order), method: :patch, params: { order_action: 'cancel' }, class: "btn btn-outline", style: "color: var(--color-error); border-color: var(--color-error);", data: { confirm: "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?" } %>
    <% end %>
  </div>
</div>

<!-- Main Content Grid -->
<div class="grid" style="grid-template-columns: 2fr 1fr; gap: var(--space-6);">
  <!-- Order Items -->
  <div class="card">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-5);">–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</h2>

    <div style="display: flex; flex-direction: column; gap: var(--space-4);">
      <% @items.each do |item| %>
        <div style="display: flex; gap: var(--space-4); padding: var(--space-4); border: 1px solid var(--gray-200); border-radius: var(--radius-md);">
          <!-- Product Icon -->
          <div style="
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            border-radius: var(--radius-md);
            background: rgba(79, 70, 229, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
          ">
            <%= product_icon(item.product.product_type) %>
          </div>

          <!-- Product Info -->
          <div style="flex: 1;">
            <h3 style="font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-1);">
              <%= item.product.name %>
            </h3>
            <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-2);">
              <%= product_type_label(item.product.product_type) %>
            </div>
            <div style="font-size: 0.875rem; color: var(--gray-700);">
              <%= item.quantity %> √ó <%= format_currency(item.price_kopecks) %>
            </div>
          </div>

          <!-- Price -->
          <div style="text-align: right;">
            <div style="font-size: 1.125rem; font-weight: 600; color: var(--gray-900);">
              <%= format_currency(item.price_kopecks * item.quantity) %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Total -->
    <div style="margin-top: var(--space-6); padding-top: var(--space-6); border-top: 2px solid var(--gray-200);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">–ò—Ç–æ–≥–æ:</span>
        <span style="font-size: 1.875rem; font-weight: 700; color: var(--primary);">
          <%= format_currency(@order.total_kopecks) %>
        </span>
      </div>
    </div>
  </div>

  <!-- Order Details Sidebar -->
  <div>
    <!-- Customer Info -->
    <div class="card" style="margin-bottom: var(--space-6);">
      <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-4);">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>

      <div style="display: flex; flex-direction: column; gap: var(--space-3);">
        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–ò–º—è:</div>
          <div style="font-weight: 500; color: var(--gray-900);"><%= @order.user.full_name %></div>
        </div>

        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">Email:</div>
          <div style="font-weight: 500; color: var(--gray-900);"><%= @order.user.email %></div>
        </div>

        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞:</div>
          <span style="<%= classification_badge_style(@order.user.classification) %> padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">
            <%= classification_label(@order.user.classification) %>
          </span>
        </div>

        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞:</div>
          <div style="font-weight: 600; color: var(--color-success);"><%= format_currency(@order.user.wallet.balance_kopecks) %></div>
        </div>
      </div>

      <%= link_to "–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí", admin_user_path(@order.user), style: "display: inline-block; margin-top: var(--space-4); color: var(--primary); text-decoration: none; font-size: 0.875rem; font-weight: 500;" %>
    </div>

    <!-- Payment Info -->
    <div class="card">
      <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-4);">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ</h3>

      <div style="display: flex; flex-direction: column; gap: var(--space-3);">
        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</div>
          <div style="font-weight: 600; color: var(--gray-900); font-family: monospace;"><%= @order.order_number %></div>
        </div>

        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</div>
          <div style="color: var(--gray-900);"><%= @order.created_at.strftime('%d.%m.%Y %H:%M') %></div>
        </div>

        <% if @order.paid_at.present? %>
          <div>
            <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</div>
            <div style="color: var(--gray-900);"><%= @order.paid_at.strftime('%d.%m.%Y %H:%M') %></div>
          </div>
        <% end %>

        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã:</div>
          <div style="color: var(--gray-900);">
            <% case @order.payment_method %>
            <% when 'wallet' %>
              üí∞ –ö–æ—à–µ–ª–µ–∫
            <% when 'cloudpayments' %>
              üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞
            <% else %>
              –ù–µ —É–∫–∞–∑–∞–Ω
            <% end %>
          </div>
        </div>

        <% if @order.payment_id.present? %>
          <div>
            <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: var(--space-1);">ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</div>
            <div style="color: var(--gray-900); font-family: monospace; font-size: 0.875rem;"><%= @order.payment_id %></div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
