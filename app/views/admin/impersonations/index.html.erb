<% content_for :title, "История имперсонации" %>

<h1 style="font-size: 1.875rem; font-weight: 700; margin-bottom: var(--space-6); color: var(--gray-900);">
  История входов за пользователей
</h1>

<!-- Статистика -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); margin-bottom: var(--space-6);">
  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 2rem; font-weight: 700; color: var(--color-warning); margin-bottom: var(--space-2);"><%= @stats[:active_count] %></div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">Активные сейчас</div>
  </div>
  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: var(--space-2);"><%= @stats[:today_count] %></div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">Сегодня</div>
  </div>
  <div class="card" style="padding: var(--space-5);">
    <div style="font-size: 2rem; font-weight: 700; color: var(--gray-700); margin-bottom: var(--space-2);"><%= @stats[:total_count] %></div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">Всего</div>
  </div>
</div>

<!-- Активные сессии -->
<% if @active_sessions.any? %>
  <div class="card" style="margin-bottom: var(--space-6);">
    <h2 style="font-size: 1.125rem; font-weight: 600; padding: var(--space-5); border-bottom: 1px solid var(--gray-200);">
      Активные сессии (<%= @active_sessions.total_count %>)
    </h2>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid var(--gray-200);">
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Администратор</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Пользователь</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Начало</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Истекает</th>
          <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Действия</th>
        </tr>
      </thead>
      <tbody>
        <% @active_sessions.each do |log| %>
          <tr style="border-bottom: 1px solid var(--gray-100);">
            <td style="padding: var(--space-4); font-weight: 500;"><%= log.admin.email %></td>
            <td style="padding: var(--space-4); font-weight: 500;"><%= log.user.email %></td>
            <td style="padding: var(--space-4); font-size: 0.875rem; color: var(--gray-600);"><%= l(log.started_at, format: :short) %></td>
            <td style="padding: var(--space-4); font-size: 0.875rem; color: var(--gray-600);"><%= l(log.started_at + ImpersonationLog::MAX_DURATION_HOURS.hours, format: :short) %></td>
            <td style="padding: var(--space-4); text-align: right;">
              <%= link_to "Детали", admin_impersonation_path(log), style: "padding: var(--space-2) var(--space-3); color: var(--primary); text-decoration: none; font-size: 0.875rem;" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <%= paginate @active_sessions, param_name: :page %>
  </div>
<% end %>

<!-- Завершенные сессии -->
<div class="card">
  <h2 style="font-size: 1.125rem; font-weight: 600; padding: var(--space-5); border-bottom: 1px solid var(--gray-200);">
    Завершенные сессии (<%= @recent_sessions.total_count %>)
  </h2>
  <% if @recent_sessions.any? %>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid var(--gray-200);">
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Администратор</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Пользователь</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Начало</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Конец</th>
          <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Длительность</th>
          <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Действия</th>
        </tr>
      </thead>
      <tbody>
        <% @recent_sessions.each do |log| %>
          <tr style="border-bottom: 1px solid var(--gray-100);">
            <td style="padding: var(--space-4); font-weight: 500;"><%= log.admin.email %></td>
            <td style="padding: var(--space-4); font-weight: 500;"><%= log.user.email %></td>
            <td style="padding: var(--space-4); font-size: 0.875rem; color: var(--gray-600);"><%= l(log.started_at, format: :short) %></td>
            <td style="padding: var(--space-4); font-size: 0.875rem; color: var(--gray-600);"><%= l(log.ended_at, format: :short) %></td>
            <td style="padding: var(--space-4); font-size: 0.875rem; color: var(--gray-600);"><%= log.duration_human %></td>
            <td style="padding: var(--space-4); text-align: right;">
              <%= link_to "Детали", admin_impersonation_path(log), style: "padding: var(--space-2) var(--space-3); color: var(--primary); text-decoration: none; font-size: 0.875rem;" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <%= paginate @recent_sessions, param_name: :recent_page %>
  <% else %>
    <div style="padding: var(--space-12); text-align: center; color: var(--gray-500);">
      Завершенных сессий пока нет
    </div>
  <% end %>
</div>
