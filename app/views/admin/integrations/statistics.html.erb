<% content_for :title, "Статистика: #{@integration.name}" %>

<div style="margin-bottom: var(--space-8);">
  <%= link_to admin_integration_path(@integration), style: "display: inline-flex; align-items: center; gap: var(--space-2); color: var(--gray-600); text-decoration: none; font-size: 0.875rem; margin-bottom: var(--space-3);" do %>
    ← Назад к интеграции
  <% end %>
  <h1 style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
    Статистика: <%= @integration.name %>
  </h1>
</div>

<!-- Period Selector -->
<div class="card" style="padding: var(--space-4); margin-bottom: var(--space-6); display: flex; gap: var(--space-3);">
  <%= link_to 'День', statistics_admin_integration_path(@integration, period: 'daily'), style: "padding: var(--space-2) var(--space-4); border-radius: var(--radius-md); text-decoration: none; font-weight: 500; transition: all 0.2s; #{@period == 'daily' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-700);'}" %>
  <%= link_to 'Неделя', statistics_admin_integration_path(@integration, period: 'weekly'), style: "padding: var(--space-2) var(--space-4); border-radius: var(--radius-md); text-decoration: none; font-weight: 500; transition: all 0.2s; #{@period == 'weekly' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-700);'}" %>
  <%= link_to 'Месяц', statistics_admin_integration_path(@integration, period: 'monthly'), style: "padding: var(--space-2) var(--space-4); border-radius: var(--radius-md); text-decoration: none; font-weight: 500; transition: all 0.2s; #{@period == 'monthly' ? 'background: var(--primary); color: white;' : 'background: var(--gray-100); color: var(--gray-700);'}" %>
</div>

<!-- Summary Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
  <% total_requests = @statistics.sum(&:total_requests) %>
  <% successful_requests = @statistics.sum(&:successful_requests) %>
  <% failed_requests = @statistics.sum(&:failed_requests) %>
  <% avg_success_rate = total_requests > 0 ? (successful_requests.to_f / total_requests * 100).round(1) : 0 %>

  <div class="card" style="padding: var(--space-6);">
    <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
      <div style="width: 48px; height: 48px; background: rgba(79, 70, 229, 0.05); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
      </div>
      <div>
        <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">
          Всего запросов
        </div>
        <div style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
          <%= number_with_delimiter(total_requests) %>
        </div>
      </div>
    </div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">
      За <%= case @period when 'daily' then 'последние 30 дней' when 'weekly' then 'последние 12 недель' else 'последние 12 месяцев' end %>
    </div>
  </div>

  <div class="card" style="padding: var(--space-6);">
    <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
      <div style="width: 48px; height: 48px; background: rgba(34, 197, 94, 0.1); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div>
        <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">
          Успешных
        </div>
        <div style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
          <%= number_with_delimiter(successful_requests) %>
        </div>
      </div>
    </div>
    <div style="font-size: 0.875rem; color: var(--color-success);">
      <%= avg_success_rate %>% от общего числа
    </div>
  </div>

  <div class="card" style="padding: var(--space-6);">
    <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
      <div style="width: 48px; height: 48px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      </div>
      <div>
        <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">
          Ошибок
        </div>
        <div style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
          <%= number_with_delimiter(failed_requests) %>
        </div>
      </div>
    </div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">
      <%= (100 - avg_success_rate).round(1) %>% от общего числа
    </div>
  </div>

  <% if @statistics.any? && @statistics.map(&:avg_duration_ms).compact.any? %>
    <% avg_duration = @statistics.map(&:avg_duration_ms).compact.sum / @statistics.map(&:avg_duration_ms).compact.size %>
    <div class="card" style="padding: var(--space-6);">
      <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
        <div style="width: 48px; height: 48px; background: rgba(168, 85, 247, 0.1); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#A855F7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div>
          <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">
            Средняя скорость
          </div>
          <div style="font-size: 1.875rem; font-weight: 700; color: var(--gray-900);">
            <%= avg_duration.round %>ms
          </div>
        </div>
      </div>
      <div style="font-size: 0.875rem; color: var(--gray-600);">
        <%= (avg_duration / 1000.0).round(2) %> секунд
      </div>
    </div>
  <% end %>
</div>

<!-- Chart Placeholder -->
<div class="card" style="padding: var(--space-6); margin-bottom: var(--space-6);">
  <h2 style="font-size: 1.125rem; font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-6);">
    График активности
  </h2>

  <% if @statistics.any? %>
    <!-- Simple bar chart visualization -->
    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
      <% max_value = @statistics.map(&:total_requests).max %>
      <% @statistics.reverse.first(15).reverse.each do |stat| %>
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1); font-size: 0.75rem; color: var(--gray-600);">
            <span><%= stat.date.strftime('%d %b') %></span>
            <span><%= stat.total_requests %> запросов</span>
          </div>
          <div style="display: flex; gap: 2px; height: 24px;">
            <% if stat.total_requests > 0 %>
              <% success_width = (stat.successful_requests.to_f / max_value * 100).round(1) %>
              <% failed_width = (stat.failed_requests.to_f / max_value * 100).round(1) %>
              <div title="Успешно: <%= stat.successful_requests %>" style="width: <%= success_width %>%; background: #16a34a; border-radius: var(--radius-sm); transition: all 0.3s;" onmouseover="this.style.opacity='0.8';" onmouseout="this.style.opacity='1';"></div>
              <div title="Ошибки: <%= stat.failed_requests %>" style="width: <%= failed_width %>%; background: #ef4444; border-radius: var(--radius-sm); transition: all 0.3s;" onmouseover="this.style.opacity='0.8';" onmouseout="this.style.opacity='1';"></div>
            <% else %>
              <div style="width: 100%; background: var(--gray-100); border-radius: var(--radius-sm);"></div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div style="display: flex; gap: var(--space-6); margin-top: var(--space-6); padding-top: var(--space-4); border-top: 1px solid var(--gray-200); font-size: 0.875rem;">
      <div style="display: flex; align-items: center; gap: var(--space-2);">
        <div style="width: 12px; height: 12px; background: #16a34a; border-radius: var(--radius-sm);"></div>
        <span style="color: var(--gray-700);">Успешные запросы</span>
      </div>
      <div style="display: flex; align-items: center; gap: var(--space-2);">
        <div style="width: 12px; height: 12px; background: #ef4444; border-radius: var(--radius-sm);"></div>
        <span style="color: var(--gray-700);">Ошибки</span>
      </div>
    </div>
  <% else %>
    <div style="text-align: center; padding: var(--space-12); color: var(--gray-500);">
      <p>Недостаточно данных для построения графика</p>
      <p style="font-size: 0.875rem; margin-top: var(--space-2);">
        Статистика будет доступна после использования интеграции
      </p>
    </div>
  <% end %>
</div>

<!-- Detailed Table -->
<% if @statistics.any? %>
  <div class="card" style="padding: var(--space-6);">
    <h2 style="font-size: 1.125rem; font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-6);">
      Детальная статистика
    </h2>

    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
        <thead>
          <tr style="border-bottom: 1px solid var(--gray-200);">
            <th style="padding: var(--space-4); text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Дата</th>
            <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Всего</th>
            <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Успешно</th>
            <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Ошибок</th>
            <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Success Rate</th>
            <th style="padding: var(--space-4); text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase;">Avg Duration</th>
          </tr>
        </thead>
        <tbody>
          <% @statistics.reverse.each do |stat| %>
            <tr style="border-bottom: 1px solid var(--gray-100);">
              <td style="padding: var(--space-4); font-size: 0.875rem; color: var(--gray-900); font-weight: 500;">
                <%= l(stat.date, format: :long) %>
              </td>
              <td style="padding: var(--space-4); text-align: right; font-size: 0.875rem; color: var(--gray-700);">
                <%= number_with_delimiter(stat.total_requests) %>
              </td>
              <td style="padding: var(--space-4); text-align: right; font-size: 0.875rem; color: #16a34a; font-weight: 500;">
                <%= number_with_delimiter(stat.successful_requests) %>
              </td>
              <td style="padding: var(--space-4); text-align: right; font-size: 0.875rem; color: #ef4444; font-weight: 500;">
                <%= number_with_delimiter(stat.failed_requests) %>
              </td>
              <td style="padding: var(--space-4); text-align: right; font-size: 0.875rem;">
                <span style="padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; <%= stat.success_rate_percentage >= 95 ? 'background: rgba(34, 197, 94, 0.1); color: #16a34a;' : stat.success_rate_percentage >= 80 ? 'background: rgba(245, 158, 11, 0.1); color: #f59e0b;' : 'background: rgba(239, 68, 68, 0.1); color: #ef4444;' %>">
                  <%= stat.success_rate_percentage.round(1) %>%
                </span>
              </td>
              <td style="padding: var(--space-4); text-align: right; font-size: 0.875rem; color: var(--gray-600);">
                <%= stat.avg_duration_ms ? "#{stat.avg_duration_ms}ms" : '—' %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>
