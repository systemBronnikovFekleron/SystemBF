<% content_for :title, "–ó–∞—è–≤–∫–∞ #{@order_request.request_number} - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" %>

<div style="padding: 2rem;">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
      <h1 class="text-gradient" style="margin-bottom: 0.5rem;">
        <%= @order_request.request_number %>
      </h1>
      <p style="color: var(--gray-600);">
        <%= l(@order_request.created_at, format: :long) %>
      </p>
    </div>
    <%= render partial: 'shared/order_request_status_badge', locals: { status: @order_request.status } %>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2">
      <!-- User Information -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem;">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
        <dl style="display: grid; grid-template-columns: auto 1fr; gap: 1rem 2rem;">
          <dt style="font-weight: 600; color: var(--gray-700);">–ò–º—è:</dt>
          <dd style="color: var(--gray-900);"><%= @order_request.user.full_name %></dd>

          <dt style="font-weight: 600; color: var(--gray-700);">Email:</dt>
          <dd style="color: var(--gray-900);"><%= @order_request.user.email %></dd>

          <dt style="font-weight: 600; color: var(--gray-700);">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:</dt>
          <dd>
            <span class="badge badge-secondary">
              <%= @order_request.user.classification.humanize %>
            </span>
          </dd>

          <dt style="font-weight: 600; color: var(--gray-700);">–ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞:</dt>
          <dd>
            <% wallet_balance = @order_request.user.wallet.balance_kopecks %>
            <% sufficient = wallet_balance >= @order_request.total_kopecks %>
            <span style="font-weight: 700; font-size: 1.25rem; color: <%= sufficient ? 'var(--color-success)' : 'var(--color-error)' %>;">
              <%= humanized_money_with_symbol(Money.new(wallet_balance, 'RUB')) %>
            </span>
            <% if sufficient %>
              <span style="color: var(--color-success); margin-left: 0.5rem;">‚úì –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
            <% else %>
              <% shortfall = @order_request.total_kopecks - wallet_balance %>
              <span style="color: var(--color-error); margin-left: 0.5rem;">
                ‚úó –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç <%= humanized_money_with_symbol(Money.new(shortfall, 'RUB')) %>
              </span>
            <% end %>
          </dd>
        </dl>
      </div>

      <!-- Product Information -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem;">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ</h3>
        <div style="display: flex; gap: 1.5rem; align-items: start;">
          <div style="font-size: 4rem; padding: 1rem; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(147, 51, 234, 0.05)); border-radius: 8px;">
            <%= product_icon(@order_request.product.product_type) %>
          </div>
          <div style="flex: 1;">
            <h4 style="margin-bottom: 0.5rem;"><%= @order_request.product.name %></h4>
            <p style="color: var(--gray-600); margin-bottom: 1rem;">
              <%= product_type_label(@order_request.product.product_type) %>
            </p>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                <%= humanized_money_with_symbol(@order_request.total) %>
              </span>
              <%= link_to "–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí", admin_product_path(@order_request.product), class: "btn btn-secondary btn-sm" %>
            </div>
            <% if @order_request.product.auto_approve %>
              <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--color-success); border-radius: 4px;">
                <strong>‚ö° –ê–≤—Ç–æ–æ–¥–æ–±—Ä–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ</strong>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Form Data (if any) -->
      <% if @order_request.form_data.present? && @order_request.form_data.any? %>
        <div class="card" style="margin-bottom: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">üìù –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã</h3>
          <dl style="display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem;">
            <% @order_request.form_data.each do |key, value| %>
              <dt style="font-weight: 600; color: var(--gray-700);"><%= key.humanize %>:</dt>
              <dd style="color: var(--gray-600);"><%= value %></dd>
            <% end %>
          </dl>
        </div>
      <% end %>

      <!-- Rejection Reason (if rejected) -->
      <% if @order_request.rejection_reason.present? %>
        <div class="card" style="background: rgba(220, 76, 62, 0.1); border-left: 4px solid var(--color-error);">
          <h4 style="color: var(--color-error); margin-bottom: 0.5rem;">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</h4>
          <p style="color: var(--gray-700);"><%= @order_request.rejection_reason %></p>
        </div>
      <% end %>
    </div>

    <!-- Sidebar: Actions -->
    <div>
      <% if @order_request.status_pending? %>
        <!-- Approve Form -->
        <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--color-success);">
          <h3 style="color: var(--color-success); margin-bottom: 1rem;">‚úì –û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É</h3>

          <% if @order_request.user.wallet.sufficient_balance?(@order_request.total_kopecks) %>
            <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
              <p style="font-size: 0.875rem; color: var(--gray-700);">
                <strong>–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è:</strong> –ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø–ª–∞—á–µ–Ω–∞ —Å –∫–æ—à–µ–ª—å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –∏ –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–¥—É–∫—Ç—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.
              </p>
            </div>
          <% else %>
            <div style="background: rgba(251, 191, 36, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
              <p style="font-size: 0.875rem; color: var(--gray-700);">
                <strong>–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è:</strong> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞. –ü–æ–∫—É–ø–∫–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.
              </p>
            </div>
          <% end %>

          <%= button_to "–û–¥–æ–±—Ä–∏—Ç—å",
                        approve_admin_order_request_path(@order_request),
                        method: :post,
                        class: "btn btn-success btn-lg",
                        style: "width: 100%;",
                        data: { confirm: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?" } %>
        </div>

        <!-- Reject Form -->
        <div class="card" style="border: 2px solid var(--color-error);">
          <h3 style="color: var(--color-error); margin-bottom: 1rem;">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</h3>

          <%= form_with url: reject_admin_order_request_path(@order_request), method: :post do |f| %>
            <div style="margin-bottom: 1rem;">
              <label for="rejection_reason" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: <span style="color: var(--color-error);">*</span>
              </label>
              <%= text_area_tag :rejection_reason, nil,
                                required: true,
                                rows: 4,
                                style: "width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-family: inherit; resize: vertical;",
                                placeholder: "–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..." %>
            </div>

            <%= f.submit "–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É",
                         class: "btn btn-danger btn-lg",
                         style: "width: 100%;",
                         data: { confirm: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?" } %>
          <% end %>
        </div>
      <% else %>
        <!-- Status Info Card -->
        <div class="card" style="text-align: center;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">
            <%= @order_request.status_approved? || @order_request.status_paid? ? '‚úì' : '‚úó' %>
          </div>
          <%= render partial: 'shared/order_request_status_badge', locals: { status: @order_request.status } %>
          <p style="color: var(--gray-600); margin-top: 1rem; font-size: 0.875rem;">
            –ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
          </p>

          <% if @order_request.order %>
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
              <p style="font-weight: 600; margin-bottom: 0.5rem;">–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω:</p>
              <%= link_to @order_request.order.order_number,
                          admin_order_path(@order_request.order),
                          class: "btn btn-primary",
                          style: "width: 100%;" %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Back Button -->
      <div style="margin-top: 1.5rem;">
        <%= link_to "‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É",
                    admin_order_requests_path,
                    class: "btn btn-secondary",
                    style: "width: 100%;" %>
      </div>
    </div>
  </div>
</div>
