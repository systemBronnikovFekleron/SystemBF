<!DOCTYPE html>
<html lang="ru">
  <head>
    <title><%= content_for(:title) || "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –°–∏—Å—Ç–µ–º–∞ –ë—Ä–æ–Ω–Ω–∏–∫–æ–≤–∞" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="–°–∏—Å—Ç–µ–º–∞ –ë—Ä–æ–Ω–Ω–∏–∫–æ–≤–∞">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <!-- Google Fonts: IBM Plex Sans + Serif –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Serif:wght@600;700&display=swap" rel="stylesheet">

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="dashboard-layout">
    <!-- Impersonation Banner -->
    <% if impersonating? %>
      <div style="position: fixed; top: 0; left: 0; right: 0; z-index: 9999; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; padding: var(--space-4); text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; justify-content: center; gap: var(--space-4); max-width: 1200px; margin: 0 auto;">
          <svg style="width: 24px; height: 24px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div style="flex: 1;">
            <strong>–†–µ–∂–∏–º –∏–º–ø–µ—Ä—Å–æ–Ω–∞—Ü–∏–∏:</strong> –≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ <strong><%= current_user.email %></strong>
            <span style="opacity: 0.9; margin-left: var(--space-2);">
              (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: <%= real_admin_user.email %>)
            </span>
          </div>
          <%= button_to "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é",
              admin_impersonation_path(current_impersonation),
              method: :delete,
              style: "padding: var(--space-2) var(--space-4); background: white; color: #D97706; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; flex-shrink: 0;" %>
        </div>
      </div>
      <div style="height: 72px;"></div> <!-- Spacer –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ -->
    <% end %>

    <!-- Sidebar -->
    <%= render "shared/sidebar" %>

    <!-- Main Content Area -->
    <div class="dashboard-main">
      <!-- Top Header -->
      <header class="dashboard-header">
        <div class="dashboard-header-content">
          <div>
            <h1 style="font-size: 1.5rem; font-weight: 600; color: var(--gray-900); margin: 0;">
              <%= content_for?(:page_title) ? yield(:page_title) : "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" %>
            </h1>
            <% if content_for?(:page_subtitle) %>
              <p style="color: var(--gray-600); margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                <%= yield(:page_subtitle) %>
              </p>
            <% end %>
          </div>

          <!-- User Profile & Actions -->
          <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- Wallet Balance -->
            <a href="/dashboard/wallet" class="header-stat-btn" title="–ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞">
              <span style="font-size: 1rem;">üí∞</span>
              <span style="font-weight: 600; color: var(--primary);">
                <%= format_currency(current_user&.wallet&.balance_kopecks || 0) %>
              </span>
            </a>

            <!-- Rating -->
            <a href="/dashboard/rating" class="header-stat-btn" title="–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥">
              <span style="font-size: 1rem;">‚≠ê</span>
              <span style="font-weight: 600; color: var(--secondary);">
                <%= current_user&.rating&.points || 0 %>
              </span>
            </a>

            <div style="width: 1px; height: 2rem; background: var(--gray-200);"></div>

            <!-- My Requests -->
            <%= link_to order_requests_path, class: "dashboard-icon-btn", title: "–ú–æ–∏ –∑–∞—è–≤–∫–∏" do %>
              <span style="font-size: 1.25rem;">üìã</span>
            <% end %>

            <!-- Notifications -->
            <a href="/dashboard/notifications" class="dashboard-icon-btn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
              <span style="font-size: 1.25rem;">üîî</span>
              <span class="badge badge-error" style="position: absolute; top: -0.25rem; right: -0.25rem; font-size: 0.625rem; padding: 0.125rem 0.375rem;">3</span>
            </a>

            <div style="width: 1px; height: 2rem; background: var(--gray-200);"></div>

            <!-- User Profile -->
            <a href="/dashboard/profile" class="header-profile-btn" title="–ü—Ä–æ—Ñ–∏–ª—å">
              <div style="
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: rgba(79, 70, 229, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
              ">
                üë§
              </div>
              <div style="text-align: left;">
                <div style="font-weight: 500; color: var(--gray-900); font-size: 0.875rem; line-height: 1.2;">
                  <%= current_user&.first_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" %> <%= current_user&.last_name %>
                </div>
                <div style="font-size: 0.6875rem;">
                  <%= classification_badge(current_user&.classification || 'guest') %>
                </div>
              </div>
            </a>

            <!-- Settings -->
            <a href="/dashboard/settings" class="dashboard-icon-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
              <span style="font-size: 1.25rem;">‚öôÔ∏è</span>
            </a>
          </div>
        </div>
      </header>

      <!-- Content -->
      <main class="dashboard-content">
        <%= render "shared/flash" if flash.any? %>
        <%= yield %>
      </main>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <button class="mobile-sidebar-toggle" onclick="document.querySelector('.dashboard-sidebar').classList.toggle('open')">
      <span>‚ò∞</span>
    </button>
  </body>
</html>

<style>
  /* Dashboard Layout Styles */
  .dashboard-layout {
    display: flex;
    min-height: 100vh;
    background: #fafafa;
  }

  .dashboard-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-left: 240px;
    transition: margin-left 200ms ease;
  }

  .dashboard-header {
    background: white;
    border-bottom: 1px solid var(--gray-200);
    padding: var(--space-4) var(--space-8);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .dashboard-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-6);
  }

  .dashboard-icon-btn {
    position: relative;
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    background: transparent;
    border: 1px solid transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    text-decoration: none;
    font-size: 18px;
  }

  .dashboard-icon-btn:hover {
    background: var(--gray-100);
  }

  .header-stat-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    text-decoration: none;
    transition: all var(--transition-base);
    font-size: 0.875rem;
  }

  .header-stat-btn:hover {
    background: var(--gray-100);
    border-color: var(--gray-300);
  }

  .header-profile-btn {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    background: white;
    border: 1px solid var(--gray-200);
    text-decoration: none;
    transition: all var(--transition-base);
  }

  .header-profile-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-300);
  }

  .dashboard-content {
    flex: 1;
    padding: var(--space-8);
    background: white;
  }

  .mobile-sidebar-toggle {
    display: none;
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    background: var(--primary);
    color: white;
    border: none;
    font-size: 20px;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    z-index: 1001;
    transition: all var(--transition-base);
  }

  .mobile-sidebar-toggle:hover {
    background: var(--primary-dark);
  }

  @media (max-width: 1024px) {
    .dashboard-main {
      margin-left: 0;
    }

    .mobile-sidebar-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dashboard-header {
      padding: var(--space-4) var(--space-6);
    }

    .dashboard-header-content {
      flex-wrap: wrap;
    }

    .header-stat-btn {
      padding: var(--space-2);
      font-size: 0.8125rem;
    }

    .header-profile-btn {
      padding: var(--space-2);
    }

    .header-profile-btn > div:last-child {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .dashboard-content {
      padding: var(--space-4);
    }

    .dashboard-header-content h1 {
      font-size: 1.25rem !important;
    }
  }
</style>
