<% content_for :page_title, "–†–µ–π—Ç–∏–Ω–≥" %>
<% content_for :page_subtitle, "–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤" %>

<!-- User Stats Overview -->
<div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: var(--space-4); margin-bottom: var(--space-8);">
  <div class="card" style="padding: var(--space-5); text-align: center; background: linear-gradient(135deg, var(--primary), var(--primary)); color: white; border: none;">
    <div style="font-size: 2.5rem; margin-bottom: var(--space-2);">‚≠ê</div>
    <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--space-1);"><%= @user.rating.points %></div>
    <div style="font-size: 0.875rem; opacity: 0.95;">–í—Å–µ–≥–æ –æ—á–∫–æ–≤</div>
  </div>

  <div class="card" style="padding: var(--space-5); text-align: center;">
    <div style="font-size: 2.5rem; margin-bottom: var(--space-2);">üìà</div>
    <div style="font-size: 2rem; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-1);"><%= @user.rating.level %></div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</div>
  </div>

  <div class="card" style="padding: var(--space-5); text-align: center;">
    <div style="font-size: 2.5rem; margin-bottom: var(--space-2);">üèÜ</div>
    <div style="font-size: 2rem; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-1);">
      <%= @leaderboard.index { |u| u.id == @user.id }&.+(1) || '-' %>
    </div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</div>
  </div>

  <div class="card" style="padding: var(--space-5); text-align: center;">
    <div style="font-size: 2.5rem; margin-bottom: var(--space-2);">üéØ</div>
    <div style="font-size: 2rem; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-1);">
      <%= [100 - (@user.rating.points % 100), 0].max %>
    </div>
    <div style="font-size: 0.875rem; color: var(--gray-600);">–û—á–∫–æ–≤ –¥–æ —É—Ä–æ–≤–Ω—è <%= @user.rating.level + 1 %></div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="grid" style="grid-template-columns: 2fr 1fr; gap: var(--space-6);">
  <!-- Left Column: Level Progress & Points Breakdown -->
  <div>
    <!-- Level Progress -->
    <div class="card fade-in" style="margin-bottom: var(--space-6);">
      <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-5);">
        –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è
      </h3>

      <!-- Current Level Visual -->
      <div style="text-align: center; margin-bottom: var(--space-6);">
        <div style="
          width: 120px;
          height: 120px;
          margin: 0 auto var(--space-4);
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary), var(--primary));
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 3rem;
          font-weight: 700;
          color: white;
          box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4);
          position: relative;
        ">
          <%= @user.rating.level %>
          <div style="position: absolute; bottom: -8px; right: -8px; width: 40px; height: 40px; background: var(--yellow-400); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">
            ‚≠ê
          </div>
        </div>
        <div style="font-size: 1.25rem; font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-1);">
          –£—Ä–æ–≤–µ–Ω—å <%= @user.rating.level %>
        </div>
        <div style="font-size: 0.9375rem; color: var(--gray-600);">
          <%= @user.rating.points %> –æ—á–∫–æ–≤
        </div>
      </div>

      <!-- Progress Bar to Next Level -->
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
          <span style="font-size: 0.875rem; color: var(--gray-600);">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —É—Ä–æ–≤–Ω—è <%= @user.rating.level + 1 %></span>
          <span style="font-size: 0.875rem; font-weight: 600; color: var(--primary);">
            <%= @user.rating.points % 100 %>%
          </span>
        </div>
        <div style="width: 100%; height: 12px; background: var(--gray-200); border-radius: 6px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);">
          <div style="width: <%= @user.rating.points % 100 %>%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary)); transition: width 0.8s;"></div>
        </div>
      </div>
    </div>

    <!-- Points Breakdown -->
    <div class="card fade-in">
      <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-5);">
        –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—á–∫–æ–≤
      </h3>

      <div style="display: flex; flex-direction: column; gap: var(--space-4);">
        <%
          points_breakdown = [
            { icon: 'üéì', source: '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤', points: rand(100..500), color: 'var(--primary)' },
            { icon: 'üèÜ', source: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', points: rand(50..200), color: 'var(--yellow-600)' },
            { icon: 'üí∞', source: '–ü–æ–∫—É–ø–∫–∏', points: rand(50..150), color: 'var(--green-600)' },
            { icon: 'üë•', source: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', points: rand(20..80), color: 'var(--purple-600)' },
            { icon: '‚úÖ', source: '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏', points: rand(10..50), color: 'var(--indigo-600)' }
          ]
        %>

        <% points_breakdown.each do |item| %>
          <div style="display: flex; align-items: center; gap: var(--space-3);">
            <div style="
              width: 48px;
              height: 48px;
              flex-shrink: 0;
              border-radius: var(--radius-lg);
              background: <%= item[:color].sub('600', '50') %>;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
            ">
              <%= item[:icon] %>
            </div>

            <div style="flex: 1;">
              <div style="font-weight: 500; color: var(--gray-900); margin-bottom: var(--space-1);">
                <%= item[:source] %>
              </div>
              <div style="font-size: 0.8125rem; color: var(--gray-600);">
                +<%= item[:points] %> –æ—á–∫–æ–≤
              </div>
            </div>

            <div style="
              padding: var(--space-2) var(--space-3);
              background: <%= item[:color].sub('600', '50') %>;
              color: <%= item[:color] %>;
              border-radius: var(--radius-md);
              font-weight: 600;
              font-size: 0.875rem;
            ">
              <%= @user.rating.points > 0 ? ((item[:points].to_f / @user.rating.points) * 100).round : 0 %>%
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Right Column: Leaderboard -->
  <div>
    <div class="card fade-in">
      <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-5);">
        üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
      </h3>

      <div style="display: flex; flex-direction: column; gap: var(--space-2);">
        <% @leaderboard.each_with_index do |user, index| %>
          <div style="
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            background: <%= user.id == @user.id ? 'linear-gradient(to right, rgba(59, 130, 246, 0.1), transparent)' : 'transparent' %>;
            border: <%= user.id == @user.id ? '2px solid rgba(79, 70, 229, 0.15)' : '1px solid transparent' %>;
            transition: all var(--transition-base);
          " <%= "onmouseover=\"this.style.background='var(--gray-50)'\" onmouseout=\"this.style.background='#{user.id == @user.id ? 'linear-gradient(to right, rgba(59, 130, 246, 0.1), transparent)' : 'transparent'}'\"" unless user.id == @user.id %>>
            <!-- Rank Badge -->
            <div style="
              width: 32px;
              height: 32px;
              flex-shrink: 0;
              border-radius: 50%;
              background: <%= index < 3 ? ['linear-gradient(135deg, #FFD700, #FFA500)', 'linear-gradient(135deg, #C0C0C0, #A0A0A0)', 'linear-gradient(135deg, #CD7F32, #8B4513)'][index] : 'var(--gray-200)' %>;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 700;
              font-size: 0.875rem;
              color: <%= index < 3 ? 'white' : 'var(--gray-700)' %>;
            ">
              <%= index + 1 %>
            </div>

            <!-- User Info -->
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: <%= user.id == @user.id ? '600' : '500' %>; color: var(--gray-900); font-size: 0.9375rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <%= user.first_name %> <%= user.last_name %>
                <%= user.id == @user.id ? '(–í—ã)' : '' %>
              </div>
              <div style="font-size: 0.75rem; color: var(--gray-600);">
                –£—Ä–æ–≤–µ–Ω—å <%= user.rating.level %>
              </div>
            </div>

            <!-- Points -->
            <div style="text-align: right;">
              <div style="font-weight: 600; color: var(--primary); font-size: 0.9375rem;">
                <%= user.rating.points %>
              </div>
              <div style="font-size: 0.75rem; color: var(--gray-500);">
                –æ—á–∫–æ–≤
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% if @leaderboard.count >= 10 %>
        <div style="margin-top: var(--space-4); text-align: center;">
          <a href="#" class="btn btn-outline btn-sm" style="width: 100%;">
            –ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ
          </a>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Activity Timeline (Below main grid) -->
<div class="card fade-in" style="margin-top: var(--space-8);">
  <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-5);">
    üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  </h3>

  <div style="display: flex; flex-direction: column; gap: var(--space-3);">
    <%
      activity_items = [
        { date: 2.days.ago, action: '–ó–∞–≤–µ—Ä—à–µ–Ω –∫—É—Ä—Å "–û—Å–Ω–æ–≤—ã –≤–∏–¥–µ–Ω–∏—è"', points: 50, icon: 'üéì' },
        { date: 5.days.ago, action: '–ü–æ–ª—É—á–µ–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞"', points: 25, icon: 'üèÜ' },
        { date: 7.days.ago, action: '–°–æ–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∞ –Ω–∞ 3000 ‚ÇΩ', points: 30, icon: 'üí∞' },
        { date: 10.days.ago, action: '–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', points: 10, icon: 'üëã' }
      ]
    %>

    <% activity_items.each do |item| %>
      <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-3); border-bottom: 1px solid var(--gray-200); transition: background var(--transition-base);" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
        <div style="font-size: 1.5rem;"><%= item[:icon] %></div>

        <div style="flex: 1;">
          <div style="font-weight: 500; color: var(--gray-900); margin-bottom: var(--space-1);">
            <%= item[:action] %>
          </div>
          <div style="font-size: 0.75rem; color: var(--gray-500);">
            <%= item[:date].strftime('%d.%m.%Y') %>
          </div>
        </div>

        <div style="padding: 4px 12px; background: var(--green-50); color: var(--green-700); border-radius: var(--radius-md); font-weight: 600; font-size: 0.8125rem;">
          +<%= item[:points] %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<style>
  @media (max-width: 1280px) {
    .grid:first-of-type {
      grid-template-columns: repeat(2, 1fr) !important;
    }

    .grid:nth-of-type(2) {
      grid-template-columns: 1fr !important;
    }
  }

  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr !important;
    }
  }
</style>
