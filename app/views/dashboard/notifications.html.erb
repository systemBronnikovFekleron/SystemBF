<% content_for :page_title, "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" %>
<% content_for :page_subtitle, "–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π" %>

<!-- Action Bar -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
  <div style="display: flex; gap: var(--space-2);">
    <button class="btn btn-sm" style="background: var(--primary); color: white;" onclick="filterNotifications('all')">
      –í—Å–µ (<%= @notifications.total_count %>)
    </button>
    <button class="btn btn-sm btn-outline" onclick="filterNotifications('unread')">
      –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (<%= @unread_count %>)
    </button>
  </div>

  <% if @unread_count > 0 %>
    <button class="btn btn-sm btn-outline" onclick="markAllAsRead()" style="color: var(--primary);">
      ‚úì –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    </button>
  <% end %>
</div>

<% if @notifications.any? %>
  <!-- Notifications Timeline -->
  <div style="max-width: 800px;">
    <% @notifications.group_by { |n| n.created_at.to_date }.each do |date, day_notifications| %>
      <!-- Date Header -->
      <div style="margin-bottom: var(--space-4); position: sticky; top: 0; background: var(--gray-50); padding: var(--space-2) 0; z-index: 10;">
        <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.05em;">
          <% if date == Date.today %>
            –°–µ–≥–æ–¥–Ω—è
          <% elsif date == Date.yesterday %>
            –í—á–µ—Ä–∞
          <% else %>
            <%= I18n.l(date, format: :long) %>
          <% end %>
        </h3>
      </div>

      <!-- Notifications for this day -->
      <div style="display: flex; flex-direction: column; gap: var(--space-3); margin-bottom: var(--space-8);">
        <% day_notifications.each do |notification| %>
          <div class="card notification-card fade-in <%= 'unread' unless notification.read? %>"
               data-notification-id="<%= notification.id %>"
               data-read="<%= notification.read? %>"
               style="position: relative; <%= 'border-left: 4px solid var(--primary);' unless notification.read? %>">

            <!-- Notification Icon & Type -->
            <div style="display: flex; gap: var(--space-4);">
              <!-- Icon Circle -->
              <div style="
                width: 48px;
                height: 48px;
                flex-shrink: 0;
                border-radius: 50%;
                background: <%= notification_background(notification.notification_type) %>;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
              ">
                <%= notification.type_icon %>
              </div>

              <!-- Notification Content -->
              <div style="flex: 1;">
                <!-- Title & Time -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2);">
                  <h4 style="font-size: 1rem; font-weight: <%= notification.read? ? '500' : '600' %>; color: var(--gray-900);">
                    <%= notification.title %>
                  </h4>
                  <span style="font-size: 0.75rem; color: var(--gray-500); white-space: nowrap; margin-left: var(--space-3);">
                    <%= notification.created_at.strftime('%H:%M') %>
                  </span>
                </div>

                <!-- Description -->
                <% if notification.message.present? %>
                  <p style="font-size: 0.875rem; color: var(--gray-600); line-height: 1.5; margin-bottom: var(--space-3);">
                    <%= notification.message %>
                  </p>
                <% end %>

                <!-- Action Button (if applicable) -->
                <% if notification.action_url.present? %>
                  <a href="<%= notification.action_url %>" class="btn btn-sm btn-outline" style="margin-top: var(--space-2);">
                    <%= notification.action_text || '–ü–æ–¥—Ä–æ–±–Ω–µ–µ' %> ‚Üí
                  </a>
                <% end %>
              </div>
            </div>

            <!-- Unread Badge -->
            <% unless notification.read? %>
              <div style="position: absolute; top: 16px; right: 16px;">
                <button onclick="markAsRead(<%= notification.id %>)" style="border: none; background: none; cursor: pointer; padding: 0;">
                  <div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></div>
                </button>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Pagination -->
  <div style="margin-top: 2rem; display: flex; justify-content: center;">
    <%= paginate @notifications %>
  </div>
<% else %>
  <!-- Empty State -->
  <div class="card fade-in" style="text-align: center; padding: var(--space-16) var(--space-8);">
    <div style="font-size: 5rem; margin-bottom: var(--space-6); opacity: 0.3;">üîî</div>
    <h3 style="font-size: 1.5rem; font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-3);">
      –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    </h3>
    <p style="font-size: 1rem; color: var(--gray-600); max-width: 400px; margin: 0 auto;">
      –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    </p>
  </div>
<% end %>

<style>
  .notification-card {
    transition: all var(--transition-base);
  }

  .notification-card:hover {
    box-shadow: 0 20px 40px rgba(79, 70, 229, 0.12);
  }

  .notification-card.unread {
    background: linear-gradient(to right, rgba(79, 70, 229, 0.03), transparent);
  }
</style>

<script>
  function filterNotifications(filter) {
    const cards = document.querySelectorAll('.notification-card');
    const buttons = document.querySelectorAll('button[onclick^="filterNotifications"]');

    // Update button styles
    buttons.forEach(btn => {
      if (btn.getAttribute('onclick').includes(`'${filter}'`)) {
        btn.className = 'btn btn-sm';
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
      } else {
        btn.className = 'btn btn-sm btn-outline';
        btn.style.background = '';
        btn.style.color = '';
      }
    });

    // Filter cards
    cards.forEach(card => {
      if (filter === 'all') {
        card.style.display = 'block';
      } else if (filter === 'unread' && card.dataset.read === 'false') {
        card.style.display = 'block';
      } else if (filter === 'unread') {
        card.style.display = 'none';
      }
    });
  }

  function markAsRead(notificationId) {
    fetch(`/dashboard/notifications/${notificationId}/read`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        const card = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (card) {
          card.classList.remove('unread');
          card.style.borderLeft = 'none';
          card.style.background = 'white';
          card.dataset.read = 'true';

          const badge = card.querySelector('[style*="width: 8px"]')?.closest('button')?.parentElement;
          if (badge) badge.remove();

          // Update counters
          const unreadButton = document.querySelector('button[onclick*="unread"]');
          if (unreadButton) {
            const match = unreadButton.innerHTML.match(/\((\d+)\)/);
            if (match) {
              const count = parseInt(match[1]) - 1;
              unreadButton.innerHTML = `–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (${count})`;
            }
          }
        }
      }
    });
  }

  function markAllAsRead() {
    const unreadCards = document.querySelectorAll('.notification-card.unread');
    const promises = [];

    unreadCards.forEach(card => {
      const notificationId = card.dataset.notificationId;
      promises.push(
        fetch(`/dashboard/notifications/${notificationId}/read`, {
          method: 'POST',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Content-Type': 'application/json'
          }
        })
      );
    });

    Promise.all(promises).then(() => {
      window.location.reload();
    });
  }
</script>

<%
# Helper method for notification background
def notification_background(type)
  case type
  when 'order_paid', 'order_completed', 'wallet_deposit'
    'rgba(15, 157, 88, 0.1)'
  when 'product_access_granted', 'order_request_approved'
    'rgba(79, 70, 229, 0.1)'
  when 'achievement_unlocked'
    'rgba(245, 158, 11, 0.1)'
  when 'wallet_withdrawal', 'wallet_refund'
    'rgba(147, 51, 234, 0.1)'
  when 'event_registration', 'event_reminder'
    'rgba(59, 130, 246, 0.1)'
  when 'system'
    'rgba(148, 163, 184, 0.1)'
  else
    'rgba(156, 163, 175, 0.1)'
  end
end
%>
